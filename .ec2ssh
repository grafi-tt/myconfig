profiles 'default', 'eratommsd'
regions 'ap-northeast-1'

$dot_ec2ssh_numbering = Hash.new(0)

# You can use methods of AWS::EC2::Instance.
# See http://docs.aws.amazon.com/AWSRubySDK/latest/AWS/EC2/Instance.html
host_line <<END
<%- if tags['Name'] =~ /^prod\.(mizuki|pop)$/ -%>
Host <%= tags['Name'] %>.<%= $dot_ec2ssh_numbering[tags['Name']] += 1 %>
<%- else -%>
Host <%= tags['Name'] %>
<%- end -%>
	HostName <%= public_ip_address || private_ip_address %>
<%- if tags['Name'] =~ /stage\.(?!ssh)/ -%>
	ProxyCommand ssh -W %h:%p stage.ssh
<%- end -%>
<%- if tags['Name'] =~ /prod\.(?!ssh)/ -%>
	ProxyCommand ssh -W %h:%p prod.ssh
<%- end -%>
<%- if tags['Name'] =~ /stage\./ -%>
	IdentityFile ~/.ssh/id_rsa.appcm_dev.pub
<%- end -%>
<%- if tags['Name'] =~ /prod\./ -%>
	IdentityFile ~/.ssh/id_rsa.appcm_prod.pub
<%- end -%>
END
